<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bredsgaard – Arbejdskort</title>
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>
  <header class="header header--brand">
    <h1>Bredsgaard – Arbejdskort</h1>
    <nav class="nav">
      <a class="button ghost" href="./admin.html">Demo Admin</a>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <h2>Nyt arbejdskort</h2>
      <div class="grid">
        <div class="field third">
          <label>Dato</label>
          <input id="date" class="input" type="date">
        </div>
        <div class="field third">
          <label>Maskin nr <span class="req">★</span></label>
          <input id="maskinNr" class="input" placeholder="Fx serienr./intern nr">
        </div>
        <div class="field third">
          <label>Maskintimer <span class="req">★</span></label>
          <input id="maskintimer" class="input" type="number" min="0" step="1" placeholder="Fx 100">
        </div>

        <div class="field third">
          <label>Kørte km <span class="req">★</span></label>
          <input id="km" class="input" type="number" min="0" step="1" placeholder="Fx 25">
        </div>
        <div class="field third">
          <label>Svejsning (timer) <span class="req">★</span></label>
          <input id="svejsningTimer" class="input" type="number" min="0" step="0.5" placeholder="Fx 1.5">
        </div>
        <div class="field third">
          <label>Elektroder (stk) <span class="req">★</span></label>
          <input id="elektroder" class="input" type="number" min="0" step="1" placeholder="Fx 10">
        </div>

        <div class="field third">
          <label>Diesel (liter) <span class="req">★</span></label>
          <input id="diesel" class="input" type="number" min="0" step="1" placeholder="Fx 5">
        </div>
        <div class="field third">
          <label>Normal timer <span class="req">★</span></label>
          <input id="normalTimer" class="input" type="number" min="0" step="0.25" placeholder="Fx 7.5">
        </div>
        <div class="field third">
          <label>Overtimer <span class="req">★</span></label>
          <input id="overtimer" class="input" type="number" min="0" step="0.25" placeholder="Fx 2">
        </div>

        <div class="field full">
          <label>Arbejdet art <span class="req">★</span></label>
          <select id="arbejdetArt" class="input"></select>
        </div>

        <div class="field full">
          <label>Fejlbeskrivelse / Udført arbejde <span class="req">★</span></label>
          <textarea id="beskrivelse" class="input" rows="4" placeholder="Skriv beskrivelse..."></textarea>
        </div>
      </div>
    </section>

    <section class="card">
      <h3>Forbrug</h3>
      <div id="consWrap" class="grid"></div>
    </section>

    <section class="card">
      <h3>Billeder (valgfrit)</h3>
      <div class="uploader">
        <p>
          <button class="button" id="pickImg">+ Tilføj billede(r)</button><br>
          <small class="hint">Antal: <b id="imgCount">0</b></small>
        </p>
        <input type="file" id="imgInput" accept="image/*" multiple>
      </div>
      <div id="thumbs" class="thumbstrip"></div>
    </section>

    <section class="card actions">
      <div class="actions__row">
        <button id="saveDraft" class="button">Gem kladde</button>
        <button id="saveSend" class="button primary">Gem &amp; send</button>
        <button id="sendEmail" class="button">Send via e-mail</button>
      </div>
      <small class="hint">
        “Arbejdet art” er altid påkrævet. Øvrige krav styres i Demo Admin. Alt gemmes lokalt.
      </small>
    </section>

    <section class="card">
      <h3>Historik (seneste 30 dage)</h3>
      <table class="table" id="histTable">
        <thead><tr><th>Dato</th><th>Arbejdet art</th><th>Status</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <footer class="footer">© Bredsgaard A/S</footer>

<script>
/* ——— Robust “no-db” demo ——— */

// SIKKER klon-utility (i stedet for structuredClone)
function cloneDeep(v){ try{ return JSON.parse(JSON.stringify(v)); }catch(e){ return v; } }

const K_SETTINGS='ak_demo_settings';
const K_CARDS='ak_demo_cards';

const DEFAULTS={
  emailRecipient:'pb@bredsgaard.dk',
  workTypes:['Service','Olieskift','Kædeskift'],
  requiredFields:['maskinNr','maskintimer','km','svejsningTimer','elektroder','diesel','normalTimer','overtimer','beskrivelse'],
  consumables:[{name:'Olie',unit:'L'},{name:'Kabler',unit:'stk'},{name:'Kobling',unit:'stk'}]
};

function load(key, fallback){
  try{ const v=localStorage.getItem(key); return v?JSON.parse(v):cloneDeep(fallback); }
  catch(e){ return cloneDeep(fallback); }
}
function save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
function ensureDefaults(){ if(!localStorage.getItem(K_SETTINGS)) save(K_SETTINGS, DEFAULTS); if(!localStorage.getItem(K_CARDS)) save(K_CARDS, []); }
function getSettings(){ return load(K_SETTINGS, DEFAULTS); }
function listCards(){ return load(K_CARDS, []); }
function putCards(xs){ save(K_CARDS, xs); }

function initForm(){
  document.getElementById('date').value = new Date().toISOString().slice(0,10);

  // Arbejdstyper
  const s=getSettings(); const sel=document.getElementById('arbejdetArt');
  sel.innerHTML = '<option value="">Vælg...</option>' + (s.workTypes||[]).map(w=>`<option>${w}</option>`).join('');

  // Forbrug
  const wrap=document.getElementById('consWrap'); wrap.innerHTML='';
  (s.consumables||[]).forEach(c=>{
    const div=document.createElement('div'); div.className='field third';
    div.innerHTML=`<label>${c.name} (${c.unit})</label><input data-name="${c.name}" data-unit="${c.unit}" class="input cons" type="number" min="0" step="1" placeholder="Fx 1">`;
    wrap.appendChild(div);
  });
}

const state={ images:[] };

function bindImages(){
  const pick=document.getElementById('pickImg');
  const input=document.getElementById('imgInput');
  const count=document.getElementById('imgCount');
  const strip=document.getElementById('thumbs');
  pick.onclick=()=>input.click();
  input.onchange=async ()=>{
    for(const f of input.files){
      await new Promise(res=>{ const r=new FileReader(); r.onload=()=>{ state.images.push(r.result); res(); }; r.readAsDataURL(f); });
    }
    count.textContent=String(state.images.length);
    renderThumbs();
  };
  function renderThumbs(){
    strip.innerHTML='';
    state.images.forEach((src,i)=>{
      const img=new Image(); img.src=src; img.className='thumb'; img.style.cursor='pointer'; img.title='Klik for at fjerne';
      img.onclick=()=>{ state.images.splice(i,1); count.textContent=String(state.images.length); renderThumbs(); };
      strip.appendChild(img);
    });
  }
}

function val(id){ return document.getElementById(id).value.trim(); }
function buildCard(status){
  const cons=Array.from(document.querySelectorAll('.cons'))
    .map(i=>({name:i.dataset.name,unit:i.dataset.unit,qty:Number(i.value||0)}))
    .filter(x=>x.qty>0);
  return {
    id: (crypto.randomUUID?crypto.randomUUID():String(Date.now())+Math.random()),
    date: val('date'), maskinNr: val('maskinNr'), maskintimer: val('maskintimer'),
    km: val('km'), svejsningTimer: val('svejsningTimer'), elektroder: val('elektroder'),
    diesel: val('diesel'), normalTimer: val('normalTimer'), overtimer: val('overtimer'),
    arbejdetsArt: val('arbejdetArt'), beskrivelse: val('beskrivelse'),
    consumables: cons, images: cloneDeep(state.images), status, createdAt: Date.now(), updatedAt: Date.now()
  };
}

function requiredOk(card){
  const s=getSettings(); const req=new Set(s.requiredFields||[]);
  if(!card.arbejdetsArt) return false;
  for(const k of req){ if(card[k]===undefined || String(card[k]).trim()==="") return false; }
  return true;
}
function saveCard(card){ const xs=listCards(); xs.unshift(card); putCards(xs); renderHistory(); }

function renderHistory(){
  const tb=document.querySelector('#histTable tbody'); tb.innerHTML='';
  const now=new Date(); const from=new Date(now.getFullYear(),now.getMonth(),now.getDate()-30);
  listCards().filter(c=> new Date(c.date)>=from && new Date(c.date)<=now)
    .forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.date}</td><td>${r.arbejdetsArt||'-'}</td><td>${r.status==='sent'?'<span class="badge sent">Sendt</span>':'<span class="badge draft">Kladde</span>'}</td>`;
      tb.appendChild(tr);
    });
}

function sendMail(card){
  const to=(getSettings().emailRecipient||'pb@bredsgaard.dk').trim();
  const lines=[
    `Dato: ${card.date}`,
    `Maskin nr: ${card.maskinNr}`,
    `Maskintimer: ${card.maskintimer}`,
    `Kørte km: ${card.km}`,
    `Svejsning (timer): ${card.svejsningTimer}`,
    `Elektroder (stk): ${card.elektroder}`,
    `Diesel (liter): ${card.diesel}`,
    `Normal timer: ${card.normalTimer}`,
    `Overtimer: ${card.overtimer}`,
    `Arbejdet art: ${card.arbejdetsArt}`,
    `Forbrug: ${(card.consumables||[]).map(c=>`${c.name} ${c.qty} ${c.unit}`).join(', ') || '-'}`,
    `Billeder: ${card.images?.length||0} (mailto vedhæfter normalt ikke)`,
    ``,
    `Fejlbeskrivelse / Udført arbejde:`,
    `${card.beskrivelse||'-'}`
  ];
  const subject=encodeURIComponent(`[Arbejdskort] ${card.date} – ${card.arbejdetsArt||'Uden art'} – ${card.maskinNr||''}`);
  const body=encodeURIComponent(lines.join('\n'));
  location.href=`mailto:${encodeURIComponent(to)}?subject=${subject}&body=${body}`;
}

// Init
ensureDefaults();
initForm();
bindImages();
renderHistory();

document.getElementById('saveDraft').onclick=()=>{ const c=buildCard('draft'); saveCard(c); alert('Kladde gemt.'); location.reload(); };
document.getElementById('saveSend').onclick=()=>{ const c=buildCard('sent'); if(!requiredOk(c)) return alert('Udfyld alle felter (★) inkl. Arbejdet art.'); saveCard(c); alert('Markeret som sendt.'); location.reload(); };
document.getElementById('sendEmail').onclick=()=>{ const c=buildCard('sent'); if(!requiredOk(c)) return alert('Udfyld alle felter (★) inkl. Arbejdet art.'); saveCard(c); sendMail(c); };
</script>
</body>
</html>




