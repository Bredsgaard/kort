<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arbejdskort</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
<header class="top">
  <div class="brand">
    <img src="img/logo.png" alt="" onerror="this.style.display='none'">
    <h1 id="appTitle">Arbejdskort</h1>
  </div>
  <nav><a href="admin.html">Admin</a></nav>
</header>

<main>
  <!-- LOCK -->
  <section id="lock" class="card">
    <h2>Log ind med kode</h2>
    <label>Kode</label>
    <input type="password" id="pin" inputmode="numeric" pattern="[0-9]*" placeholder="Fx 1234" required autofocus>
    <div class="actions">
      <button class="primary" id="unlockBtn">L√•s op</button>
    </div>
    <p id="lockMsg" class="danger" style="display:none;margin-top:8px"></p>
  </section>

  <!-- DASHBOARD -->
  <section id="dash" class="card" style="display:none">
    <div class="bar-between">
      <div>Logget ind som: <strong id="who"></strong></div>
      <button id="logout" class="secondary btn-small">Skift bruger</button>
    </div>

    <div class="actions">
      <button id="newCard" class="primary">‚ûï Nyt kort</button>
    </div>

    <h3 style="margin-top:10px">Mine kort (seneste 7 dage)</h3>
    <div id="cards"></div>
  </section>

  <!-- FORM -->
  <form id="form" style="display:none">
    <section class="card">
      <div class="bar-between">
        <div><strong>Kort-id:</strong> <span id="cardIdShort">NYT</span></div>
        <button type="button" id="backToDash" class="secondary btn-small">Tilbage</button>
      </div>

      <div class="grid-2">
        <div>
          <label>Dato</label>
          <input type="date" id="date" required />
        </div>
        <div>
          <label>Medarbejdernavn</label>
          <input type="text" id="name" placeholder="Skriv dit fulde navn" required />
        </div>
      </div>

      <label>Kunde / Firma</label>
      <input type="text" id="customer" placeholder="Fx Jensen Maskinservice" required />

      <div class="grid-2">
        <div>
          <label>Lokation</label>
          <input type="text" id="location" placeholder="Adresse/By" required />
        </div>
        <div>
          <label>Maskine / Model</label>
          <input type="text" id="machine" placeholder="Fx McConnel PA6565T" required />
        </div>
      </div>

      <label>Arbejdet art</label>
      <input type="text" id="work" placeholder="Fx Olie- og k√¶deskift" required />

      <label>Fejlbeskrivelse</label>
      <textarea id="fault" rows="3" placeholder="Kort beskrivelse af fejl" required></textarea>

      <label>Udf√∏rt arbejde</label>
      <textarea id="done" rows="3" placeholder="Hvad blev lavet?" required></textarea>

      <div class="grid-3">
        <div>
          <label>Normal timer</label>
          <input type="number" step="0.25" min="0" id="hours" value="0" required />
        </div>
        <div>
          <label>Maskintimer</label>
          <input type="number" step="0.25" min="0" id="mhours" value="0" required />
        </div>
        <div>
          <label>K√∏rte km</label>
          <input type="number" step="0.1" min="0" id="km" value="0" required />
        </div>
      </div>

      <label>Billeder (valgfrit, max 5)</label>
      <input type="file" id="images" accept="image/*" multiple />
      <div id="preview" class="preview"></div>

      <label>Noter</label>
      <textarea id="note" rows="2" placeholder="Evt. bem√¶rkninger" required></textarea>

      <div class="actions">
        <button type="button" id="save">üíæ Gem</button>
        <button type="button" id="print">Udskriv / PDF</button>
        <button type="submit" class="primary">‚úâÔ∏è Send</button>
      </div>
    </section>
  </form>
</main>

<footer>¬© Bredsgaard A/S</footer>

<script>
(() => {
  // keys
  const LS_ADMIN = 'ds_admin_v2';
  const LS_USERS = 'ds_users_v1';
  const LS_ACTIVE = 'ds_active_user_v1';
  const LS_CARDS = 'ds_cards_v1'; // [{id,user,createdAt,updatedAt,status:'draft'|'sent',fields:{...}}]

  // utils
  const $ = s => document.querySelector(s);
  const today = () => new Date().toISOString().slice(0,10);
  const uid = () => Math.random().toString(36).slice(2,8)+Date.now().toString(36).slice(-4);
  const cfg = () => JSON.parse(localStorage.getItem(LS_ADMIN)||'{}');
  const users = () => JSON.parse(localStorage.getItem(LS_USERS)||'[]');
  const activeUser = () => JSON.parse(localStorage.getItem(LS_ACTIVE)||'null');
  const setActiveUser = u => localStorage.setItem(LS_ACTIVE, JSON.stringify(u));
  const allCards = () => JSON.parse(localStorage.getItem(LS_CARDS)||'[]');
  const setCards = arr => localStorage.setItem(LS_CARDS, JSON.stringify(arr));

  // header title
  $('#appTitle').textContent = (cfg().appName || 'Arbejdskort');

  // LOCK
  $('#unlockBtn').onclick = () => {
    const pin = ($('#pin').value||'').trim();
    const list = users().filter(u=>u.active!==false);
    const u = list.find(x=>String(x.code)===pin);
    if(!u){ $('#lockMsg').textContent='Ugyldig kode eller bruger inaktiv.'; $('#lockMsg').style.display='block'; return; }
    setActiveUser(u);
    showDash();
  };

  // DASH
  function purgeOldDrafts(){
    const days = Math.max(1, parseInt(cfg().retentionDays||'7',10));
    const cutoff = Date.now() - days*24*3600*1000;
    const pruned = allCards().filter(c => !(c.status==='draft' && (new Date(c.createdAt)).getTime() < cutoff));
    setCards(pruned);
  }
  function cardsForUser(u){
    return allCards().filter(c=>c.user===u.name).sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt));
  }
  function showDash(){
    const u = activeUser();
    if(!u){ $('#lock').style.display=''; $('#dash').style.display='none'; $('#form').style.display='none'; return; }

    purgeOldDrafts();
    $('#who').textContent = u.name;
    $('#lock').style.display='none';
    $('#form').style.display='none';
    $('#dash').style.display='';

    // render cards
    const list = cardsForUser(u);
    const box = $('#cards'); box.innerHTML='';
    if(list.length===0){ box.innerHTML='<p class="hint">Ingen kort endnu. Tryk ‚ÄúNyt kort‚Äù.</p>'; }
    list.forEach(c=>{
      const div=document.createElement('div');
      div.className='card';
      const f=c.fields||{};
      div.innerHTML = `
        <div class="bar-between">
          <div><strong>${f.customer||'(uden kunde)'}</strong> ¬∑ ${f.date||''} ¬∑ <span class="${c.status==='sent'?'':'hint'}">${c.status==='sent'?'Sendt':'Udkast'}</span></div>
          <div class="actions-inline">
            <button data-id="${c.id}" class="open">√Öbn</button>
            <button data-id="${c.id}" class="del danger">Slet</button>
          </div>
        </div>`;
      box.appendChild(div);
    });
    box.querySelectorAll('.open').forEach(b=>b.onclick=e=>openCard(e.target.dataset.id));
    box.querySelectorAll('.del').forEach(b=>b.onclick=e=>{
      const id=e.target.dataset.id;
      if(confirm('Slet dette kort?')){ setCards(allCards().filter(c=>c.id!==id)); showDash(); }
    });
  }

  $('#newCard').onclick = () => {
    currentId = uid();
    loadForm({date: today(), name: activeUser().name}, true);
  };
  $('#logout').onclick = () => { localStorage.removeItem(LS_ACTIVE); location.reload(); };

  // FORM
  let currentId = null;
  function openCard(id){
    const c = allCards().find(x=>x.id===id);
    currentId = id;
    loadForm(c?.fields || {}, false, c?.status==='sent');
  }
  function loadForm(fields, isNew=false, readOnly=false){
    $('#dash').style.display='none';
    $('#form').style.display='';
    $('#cardIdShort').textContent = (isNew?'NYT':currentId.slice(0,6).toUpperCase());
    // fill
    $('#date').value = fields.date || today();
    $('#name').value = fields.name || activeUser().name;
    $('#customer').value = fields.customer || '';
    $('#location').value = fields.location || '';
    $('#machine').value = fields.machine || '';
    $('#work').value = fields.work || '';
    $('#fault').value = fields.fault || '';
    $('#done').value = fields.done || '';
    $('#hours').value = fields.hours ?? 0;
    $('#mhours').value = fields.mhours ?? 0;
    $('#km').value = fields.km ?? 0;
    $('#note').value = fields.note || '';

    // readonly hvis sendt
    [...document.querySelectorAll('#form input, #form textarea')].forEach(el=>el.disabled = readOnly && el.id!=='print' );
  }

  function gather(){
    return {
      date: $('#date').value,
      name: $('#name').value.trim(),
      customer: $('#customer').value.trim(),
      location: $('#location').value.trim(),
      machine: $('#machine').value.trim(),
      work: $('#work').value.trim(),
      fault: $('#fault').value.trim(),
      done: $('#done').value.trim(),
      hours: $('#hours').value || '0',
      mhours: $('#mhours').value || '0',
      km: $('#km').value || '0',
      note: $('#note').value.trim()
    };
  }

  function upsertCard(status='draft'){
    const u = activeUser(); if(!u) return;
    const all = allCards();
    const now = new Date().toISOString();
    const fields = gather();

    const idx = all.findIndex(c=>c.id===currentId);
    const payload = { id: currentId || uid(), user: u.name, createdAt: idx>=0?all[idx].createdAt: now, updatedAt: now, status, fields };
    if(idx>=0) all[idx]=payload; else all.push(payload);
    setCards(all);
  }

  $('#save').onclick = () => { upsertCard('draft'); alert('Kort gemt.'); };
  $('#backToDash').onclick = () => { upsertCard('draft'); showDash(); };
  $('#print').onclick = () => window.print();

  // validering baseret p√• admin "requiredFields"
  function requiredOk(){
    const r = cfg().requiredFields || [];
    const f = gather();
    for(const key of r){
      if(!String(f[key]??'').trim()){ alert('Manglende felt: '+key); return false; }
    }
    return true;
  }

  // mail
  function buildMail(fields){
    const c = cfg();
    const to = (c.emails || 'vaerksted@bredsgaard.dk').replace(/\s+/g,'');
    const subj = `${c.subjectPrefix || 'Arbejdskort'} ‚Äì ${fields.date} ‚Äì ${fields.name} ‚Äì ${fields.customer||''}`;
    const footer = (c.footer || 'Ref.: {dato} ‚Äì {medarbejder}')
      .replace('{dato}', fields.date).replace('{medarbejder}', fields.name);
    const body = `
Medarbejder: ${fields.name}
Dato: ${fields.date}

Kunde: ${fields.customer}
Lokation: ${fields.location}
Maskine: ${fields.machine}

Arbejdet art:
${fields.work}

Fejlbeskrivelse:
${fields.fault}

Udf√∏rt arbejde:
${fields.done}

Tider/forbrug:
- Normal: ${fields.hours} t
- Maskin: ${fields.mhours} t
- K√∏rsel: ${fields.km} km

Noter:
${fields.note}

${footer}`.trim();
    return `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
  }

  $('#form').addEventListener('submit', e => {
    e.preventDefault();
    // standard HTML5 krav
    if (!$('#form').reportValidity()) return;
    // admin-krav
    if (!requiredOk()) return;

    // gem og mark√©r sendt
    upsertCard('sent');

    // √•bn e-mail
    const url = buildMail(gather());
    window.location.href = url;

    // efter lidt tid ‚Üí tilbage til oversigt
    setTimeout(()=>{ showDash(); }, 300);
  });

  // billeder preview (kun visuelt)
  $('#images').addEventListener('change', () => {
    const box=$('#preview'); box.innerHTML=''; [...$('#images').files].slice(0,5).forEach(f=>{
      const img=document.createElement('img'); img.src=URL.createObjectURL(f); img.alt=f.name; box.appendChild(img);
    });
  });

  // init
  const u=activeUser(); if(u) showDash();
})();
</script>
</body>
</html>


