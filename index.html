<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dagseddel ‚Äì Bredsgaard</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
<header class="top">
  <div class="brand">
    <img src="img/logo.png" alt="" onerror="this.style.display='none'">
    <h1>Dagseddel</h1>
  </div>
  <nav>
    <a href="admin.html">Admin</a>
  </nav>
</header>

<main>
  <!-- L√ÖS / LOGIN -->
  <section id="lock" class="card">
    <h2>Log ind med kode</h2>
    <p class="hint">Indtast din medarbejderkode. Admin kan √¶ndre koder i admin.</p>
    <label>Kode</label>
    <input type="password" id="pin" inputmode="numeric" pattern="[0-9]*" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autofocus>
    <div class="actions">
      <button class="primary" id="unlockBtn">L√•s op</button>
      <button id="gotoAdmin">Admin (0705)</button>
    </div>
    <p id="lockMsg" class="danger" style="display:none;margin-top:8px"></p>
  </section>

  <!-- FORMULAREN (skjult indtil l√•st op) -->
  <form id="form" style="display:none">
    <section class="card">
      <div class="bar-between">
        <div class="who">Logget ind som: <strong id="who"></strong></div>
        <button type="button" id="switchUser" class="secondary btn-small">Skift bruger</button>
      </div>

      <div class="grid-2">
        <div>
          <label>Dato</label>
          <input type="date" id="date" required />
        </div>
        <div>
          <label>Medarbejdernavn</label>
          <input type="text" id="name" placeholder="Dit navn" required />
        </div>
      </div>

      <label>Kunde / Firma</label>
      <input type="text" id="customer" placeholder="Fx Jensen Maskinservice" />

      <div class="grid-2">
        <div>
          <label>Lokation</label>
          <input type="text" id="location" placeholder="Adresse/By" />
        </div>
        <div>
          <label>Maskine / Model</label>
          <input type="text" id="machine" placeholder="Fx McConnel PA6565T" />
        </div>
      </div>

      <label>Arbejdet art <small class="hint">Tip: brug iPhone-tastaturets üó£Ô∏è</small></label>
      <input type="text" id="work" placeholder="Fx Olie + k√¶de" required />

      <label>Fejlbeskrivelse</label>
      <textarea id="fault" rows="3" placeholder="Beskriv fejlen"></textarea>

      <label>Udf√∏rt arbejde</label>
      <textarea id="done" rows="3" placeholder="Hvad blev lavet?"></textarea>

      <div class="grid-3">
        <div>
          <label>Normal timer</label>
          <input type="number" step="0.25" id="hours" value="0" />
        </div>
        <div>
          <label>Maskintimer</label>
          <input type="number" step="0.25" id="mhours" value="0" />
        </div>
        <div>
          <label>K√∏rte km</label>
          <input type="number" step="0.1" id="km" value="0" />
        </div>
      </div>

      <label>Billeder (max 5)</label>
      <input type="file" id="images" accept="image/*" multiple />
      <div id="preview" class="preview"></div>

      <label>Noter</label>
      <textarea id="note" rows="2" placeholder="Evt. bem√¶rkninger"></textarea>

      <div class="actions">
        <button type="button" id="save">Gem kladde</button>
        <button type="button" id="print">Udskriv / PDF</button>
        <button type="submit" class="primary">Send via e-mail</button>
      </div>
      <p class="hint">‚ÄúSend‚Äù √•bner Mail/Outlook via <code>mailto:</code> p√• iPhone.</p>
    </section>
  </form>
</main>

<footer>¬© Bredsgaard A/S</footer>

<script>
(() => {
  const LS_FORM = 'ds_form_v1';
  const LS_ADMIN = 'ds_admin_v1';
  const LS_USERS = 'ds_users_v1';
  const LS_ACTIVE_USER = 'ds_active_user_v1';

  const $ = s => document.querySelector(s);
  const nowDate = () => new Date().toISOString().slice(0,10);

  // --- users storage helpers ---
  function getUsers(){
    try { return JSON.parse(localStorage.getItem(LS_USERS)||'[]'); } catch { return []; }
  }
  function getAdminCfg(){
    try { return JSON.parse(localStorage.getItem(LS_ADMIN)||'{}'); } catch { return {}; }
  }
  function setActiveUser(u){ localStorage.setItem(LS_ACTIVE_USER, JSON.stringify(u)); }
  function getActiveUser(){ try { return JSON.parse(localStorage.getItem(LS_ACTIVE_USER)||'null'); } catch { return null; } }

  // --- lock screen ---
  function tryUnlock(){
    const pin = $('#pin').value.trim();
    if (!pin) return;

    // admin direct
    const adminCode = (getAdminCfg().adminCode || '0705').trim();
    if (pin === adminCode) {
      window.location.href = 'admin.html';
      return;
    }

    const users = getUsers().filter(u => u.active!==false);
    const hit = users.find(u => String(u.code) === pin);
    if (!hit) {
      $('#lockMsg').textContent = 'Ugyldig kode eller bruger ikke aktiv.';
      $('#lockMsg').style.display = 'block';
      return;
    }
    // success
    setActiveUser(hit);
    showFormFor(hit);
  }

  function showFormFor(user){
    $('#lock').style.display = 'none';
    $('#form').style.display = '';
    $('#who').textContent = user.name;
    $('#name').value = user.name || '';
    $('#date').value = $('#date').value || nowDate();
  }

  // --- draft helpers ---
  function loadDraft(){ try{return JSON.parse(localStorage.getItem(LS_FORM)||'{}')}catch{return{}} }
  function saveDraft(v){ localStorage.setItem(LS_FORM, JSON.stringify(v)); }
  function fill(v){
    $('#date').value = v.date || nowDate();
    $('#customer').value = v.customer || '';
    $('#location').value = v.location || '';
    $('#machine').value = v.machine || '';
    $('#work').value = v.work || '';
    $('#fault').value = v.fault || '';
    $('#done').value = v.done || '';
    $('#hours').value = v.hours ?? 0;
    $('#mhours').value = v.mhours ?? 0;
    $('#km').value = v.km ?? 0;
    $('#note').value = v.note || '';
  }
  function gather(){
    return {
      date: $('#date').value,
      name: $('#name').value.trim(),
      customer: $('#customer').value.trim(),
      location: $('#location').value.trim(),
      machine: $('#machine').value.trim(),
      work: $('#work').value.trim(),
      fault: $('#fault').value.trim(),
      done: $('#done').value.trim(),
      hours: $('#hours').value || '0',
      mhours: $('#mhours').value || '0',
      km: $('#km').value || '0',
      note: $('#note').value.trim()
    };
  }
  function buildMail(vals){
    const admin = getAdminCfg();
    const to = (admin.emails || 'vaerksted@bredsgaard.dk').replace(/\s+/g,'');
    const subjectPrefix = admin.subjectPrefix || 'Dagseddel';
    const subject = `${subjectPrefix} ‚Äì ${vals.date} ‚Äì ${vals.name} ‚Äì ${vals.customer || ''}`;
    const footer = (admin.footer || 'Ref.: {dato} ‚Äì {medarbejder}')
                    .replace('{dato}', vals.date).replace('{medarbejder}', vals.name);
    const body = `
Medarbejder: ${vals.name}
Dato: ${vals.date}

Kunde: ${vals.customer}
Lokation: ${vals.location}
Maskine: ${vals.machine}

Arbejdet art:
${vals.work}

Fejlbeskrivelse:
${vals.fault}

Udf√∏rt arbejde:
${vals.done}

Tider/forbrug:
- Normal: ${vals.hours} t
- Maskin: ${vals.mhours} t
- K√∏rsel: ${vals.km} km

Noter:
${vals.note}

${footer}`.trim();

    return `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  }

  // --- init ---
  // if a user was active earlier, resume
  const active = getActiveUser();
  if (active) showFormFor(active);
  fill(loadDraft());

  // lock events
  $('#unlockBtn').addEventListener('click', tryUnlock);
  $('#pin').addEventListener('keydown', e => { if (e.key==='Enter') tryUnlock(); });
  $('#gotoAdmin').addEventListener('click', () => location.href='admin.html');

  // form events
  $('#save').addEventListener('click', () => { saveDraft(gather()); alert('Kladde gemt p√• denne enhed.'); });
  $('#print').addEventListener('click', () => window.print());
  $('#form').addEventListener('submit', e => {
    e.preventDefault();
    const vals = gather();
    if (!vals.name || !vals.work) { alert('Udfyld mindst Medarbejdernavn og Arbejdet art.'); return; }
    saveDraft(vals);
    window.location.href = buildMail(vals);
  });

  // images preview
  const input = $('#images');
  const preview = $('#preview');
  input.addEventListener('change', () => {
    preview.innerHTML = '';
    [...input.files].slice(0,5).forEach(f => {
      const img = document.createElement('img');
      img.src = URL.createObjectURL(f); img.alt = f.name;
      preview.appendChild(img);
    });
  });

  // switch user (lock)
  $('#switchUser').addEventListener('click', () => {
    localStorage.removeItem(LS_ACTIVE_USER);
    $('#form').style.display = 'none';
    $('#lock').style.display = '';
    $('#pin').value = '';
    $('#pin').focus();
  });
})();
</script>
</body>
</html>

