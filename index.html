<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arbejdskort</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
<header class="top">
  <div class="brand">
    <img src="img/logo.png" alt="" onerror="this.style.display='none'">
    <h1 id="appTitle">Arbejdskort</h1>
  </div>
  <nav><a href="admin.html">Admin</a></nav>
</header>

<main>
  <!-- LOGIN -->
  <section id="lock" class="card" autocomplete="off">
    <h2>Log ind</h2>
    <div class="grid-2">
      <div>
        <label>Brugernavn</label>
        <input id="loginUser" placeholder="fx pbo"
               autocomplete="username" autocapitalize="off" autocorrect="off" spellcheck="false" />
      </div>
      <div>
        <label>Kode</label>
        <input type="password" id="loginPin" inputmode="numeric" pattern="[0-9]*" placeholder="â€¢â€¢â€¢â€¢"
               autocomplete="new-password" autocapitalize="off" autocorrect="off" spellcheck="false" />
      </div>
    </div>
    <div class="actions">
      <button class="primary" id="unlockBtn" type="button">LÃ¥s op</button>
    </div>
    <p id="lockMsg" class="danger" style="display:none;margin-top:8px"></p>
  </section>

  <!-- DASHBOARD -->
  <section id="dash" class="card" style="display:none">
    <div class="bar-between">
      <div>Logget ind som: <strong id="who"></strong></div>
      <div class="actions-inline">
        <select id="rangeSel">
          <option value="7">Seneste 7 dage</option>
          <option value="30">Seneste 30 dage</option>
        </select>
        <button id="logout" class="secondary btn-small" type="button">Log ud</button>
      </div>
    </div>

    <div class="actions">
      <button id="newCard" class="primary" type="button">â• Nyt arbejdskort</button>
    </div>

    <h3 style="margin-top:10px">Mine arbejdskort</h3>
    <div id="cards"></div>
  </section>

  <!-- FORM -->
  <form id="form" style="display:none" autocomplete="off">
    <section class="card">
      <div class="bar-between">
        <div><strong>Kort-id:</strong> <span id="cardIdShort">NYT</span></div>
        <button type="button" id="backToDash" class="secondary btn-small">Tilbage</button>
      </div>

      <div class="grid-2">
        <div>
          <label>Dags dato</label>
          <input type="date" id="date" required />
        </div>
        <div>
          <label>Medarbejdernavn</label>
          <input type="text" id="name" required readonly />
        </div>
      </div>

      <label>Kunde / Firma</label>
      <input type="text" id="customer" placeholder="Fx Jensen Maskinservice" required />

      <div class="grid-2">
        <div>
          <label>Lokation</label>
          <input type="text" id="location" placeholder="Adresse/By" required />
        </div>
        <div>
          <label>Maskine / Model</label>
          <input type="text" id="machine" placeholder="Fx McConnel PA6565T" required />
        </div>
      </div>

      <div class="grid-3">
        <div>
          <label>Maskin nr</label>
          <input type="text" id="machineNo" placeholder="Fx serienr./intern nr" />
        </div>
        <div>
          <label>Maskintimer</label>
          <input type="number" step="0.25" min="0" id="mhours" value="0" />
        </div>
        <div>
          <label>KÃ¸rte km</label>
          <input type="number" step="0.1" min="0" id="km" value="0" />
        </div>
      </div>

      <div class="grid-3">
        <div>
          <label>Svejsning (timer)</label>
          <input type="number" step="0.25" min="0" id="welding" value="0" />
        </div>
        <div>
          <label>Elektroder (stk)</label>
          <input type="number" step="1" min="0" id="electrodes" value="0" />
        </div>
        <div>
          <label>Diesel (liter)</label>
          <input type="number" step="0.1" min="0" id="diesel" value="0" />
        </div>
      </div>

      <div class="grid-3">
        <div>
          <label>Normal timer</label>
          <input type="number" step="0.25" min="0" id="hours" value="0" />
        </div>
        <div>
          <label>Overtimer</label>
          <input type="number" step="0.25" min="0" id="overtime" value="0" />
        </div>
        <div>
          <label>Arbejdet art</label>
          <input type="text" id="work" placeholder="Fx service, olie, kÃ¦de" required />
        </div>
      </div>

      <label>Fejlbeskrivelse</label>
      <textarea id="fault" rows="3" placeholder="Kort beskrivelse af fejl"></textarea>

      <label>UdfÃ¸rt arbejde</label>
      <textarea id="done" rows="3" placeholder="Hvad blev lavet?"></textarea>

      <label>BemÃ¦rkninger</label>
      <textarea id="note" rows="2" placeholder="Evt. bemÃ¦rkninger"></textarea>

      <div class="actions">
        <button type="button" id="save">ğŸ’¾ Gem (udkast)</button>
        <button type="button" id="print">Udskriv / PDF</button>
        <button type="submit" class="primary">âœ‰ï¸ Send (markeres sendt)</button>
      </div>

      <!-- valgfrit billede-upload -->
      <div class="grid-2">
        <div>
          <label>Billeder (maks 5)</label>
          <input type="file" id="images" accept="image/*" multiple />
        </div>
        <div id="preview" class="preview"></div>
      </div>
    </section>
  </form>
</main>

<footer>Â© Bredsgaard A/S</footer>

<script>
(() => {
  const LS_ADMIN='ak_admin_v3', LS_USERS='ak_users_v2', LS_ACTIVE='ak_active_v1', LS_CARDS='ak_cards_v2';
  const $ = s => document.querySelector(s);
  const cfg = () => JSON.parse(localStorage.getItem(LS_ADMIN)||'{}');
  const users = () => JSON.parse(localStorage.getItem(LS_USERS)||'[]');
  const active = () => JSON.parse(localStorage.getItem(LS_ACTIVE)||'null');
  const setActive = u => localStorage.setItem(LS_ACTIVE, JSON.stringify(u));
  const allCards = () => JSON.parse(localStorage.getItem(LS_CARDS)||'[]');
  const setCards = a => localStorage.setItem(LS_CARDS, JSON.stringify(a));
  const today = () => new Date().toISOString().slice(0,10);
  const uid = () => Math.random().toString(36).slice(2,8)+Date.now().toString(36).slice(-4);

  document.addEventListener('DOMContentLoaded', () => {
    const u = $('#loginUser'), p = $('#loginPin');
    if (u) u.value=''; if (p) p.value='';
    $('#appTitle').textContent = cfg().appName || 'Arbejdskort';
  });

  function resetToLogin(){
    $('#lock').style.display='';
    $('#dash').style.display='none';
    $('#form').style.display='none';
    $('#loginUser').value='';
    $('#loginPin').value='';
  }

  $('#unlockBtn').onclick = () => {
    const un=($('#loginUser').value||'').trim().toLowerCase();
    const pin=($('#loginPin').value||'').trim();
    const u = users().find(x => x.active!==false && (x.username||'').toLowerCase()===un && String(x.code)===pin);
    if(!u){ $('#lockMsg').textContent='Forkert brugernavn eller kode â€“ eller bruger inaktiv.'; $('#lockMsg').style.display='block'; return; }
    setActive(u); showDash();
  };

  function purgeOldDrafts(){
    const days = Math.max(1, parseInt(cfg().retentionDays||'7',10));
    const cutoff = Date.now() - days*24*3600*1000;
    setCards(allCards().filter(c => !(c.status==='draft' && new Date(c.createdAt).getTime() < cutoff)));
  }

  function filteredCards(days){
    const u = active(); if(!u) return [];
    const cutoff = Date.now() - days*24*3600*1000;
    return allCards()
      .filter(c => c.user===u.username && new Date(c.updatedAt).getTime() >= cutoff)
      .sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt));
  }

  function renderList(){
    const days = parseInt($('#rangeSel').value,10);
    const list = filteredCards(days);
    const box = $('#cards'); box.innerHTML='';
    if(list.length===0){ box.innerHTML='<p class="hint">Ingen arbejdskort i valgt periode.</p>'; return; }
    list.forEach(c=>{
      const f=c.fields||{};
      const row=document.createElement('div');
      row.className='card';
      row.innerHTML=`
        <div class="bar-between">
          <div><strong>${f.date||''}</strong> Â· ${f.customer||'(uden kunde)'} Â· <span class="${c.status==='sent'?'':'hint'}">${c.status==='sent'?'Sendt':'Udkast'}</span></div>
          <div class="actions-inline">
            <button data-id="${c.id}" class="open">Ã…bn</button>
            <button data-id="${c.id}" class="del danger">Slet</button>
          </div>
        </div>`;
      box.appendChild(row);
    });
    box.querySelectorAll('.open').forEach(b=>b.onclick=e=>openCard(e.target.dataset.id));
    box.querySelectorAll('.del').forEach(b=>b.onclick=e=>{
      const id=e.target.dataset.id; if(confirm('Slet dette kort?')){ setCards(allCards().filter(x=>x.id!==id)); renderList(); }
    });
  }

  function showDash(){
    const u=active(); if(!u){ resetToLogin(); return; }
    purgeOldDrafts();
    $('#who').textContent = `${u.name}`; // viser kun navn
    $('#lock').style.display='none'; $('#form').style.display='none'; $('#dash').style.display='';
    renderList();
  }

  // --- Nyt arbejdskort (robust handler) ---
  function startNewCard(){
    currentId = uid();
    $('#cardIdShort').textContent='NYT';
    clearForm();
    $('#dash').style.display='none';
    $('#form').style.display='';
  }
  document.addEventListener('click', (e) => {
    const newBtn = e.target.closest('#newCard');
    if (newBtn) { e.preventDefault(); startNewCard(); }
  });

  $('#rangeSel').onchange = renderList;
  $('#logout').onclick = () => { localStorage.removeItem(LS_ACTIVE); resetToLogin(); };

  // ---- FORM ----
  let currentId=null;
  function clearForm(){
    $('#date').value=today();
    $('#name').value=active()?.name||'';
    $('#customer').value=''; $('#location').value=''; $('#machine').value=''; $('#machineNo').value='';
    $('#mhours').value=0; $('#km').value=0; $('#welding').value=0; $('#electrodes').value=0; $('#diesel').value=0;
    $('#hours').value=0; $('#overtime').value=0;
    $('#work').value=''; $('#fault').value=''; $('#done').value=''; $('#note').value='';
    const p=document.getElementById('preview'); if(p) p.innerHTML='';
  }
  $('#backToDash').onclick = ()=>{ upsert('draft'); showDash(); };
  $('#print').onclick = ()=>window.print();

  function openCard(id){
    const c=allCards().find(x=>x.id===id); if(!c) return;
    currentId=id; $('#cardIdShort').textContent=id.slice(0,6).toUpperCase();
    const f=c.fields||{};
    $('#date').value=f.date||today(); $('#name').value=active().name;
    $('#customer').value=f.customer||''; $('#location').value=f.location||''; $('#machine').value=f.machine||'';
    $('#machineNo').value=f.machineNo||''; $('#mhours').value=f.mhours??0; $('#km').value=f.km??0;
    $('#welding').value=f.welding??0; $('#electrodes').value=f.electrodes??0; $('#diesel').value=f.diesel??0;
    $('#hours').value=f.hours??0; $('#overtime').value=f.overtime??0;
    $('#work').value=f.work||''; $('#fault').value=f.fault||''; $('#done').value=f.done||''; $('#note').value=f.note||'';
    $('#dash').style.display='none'; $('#form').style.display='';
  }

  function gather(){
    return {
      date: $('#date').value, name: $('#name').value.trim(),
      customer: $('#customer').value.trim(), location: $('#location').value.trim(),
      machine: $('#machine').value.trim(), machineNo: $('#machineNo').value.trim(),
      mhours: $('#mhours').value||'0', km: $('#km').value||'0',
      welding: $('#welding').value||'0', electrodes: $('#electrodes').value||'0', diesel: $('#diesel').value||'0',
      hours: $('#hours').value||'0', overtime: $('#overtime').value||'0',
      work: $('#work').value.trim(), fault: $('#fault').value.trim(),
      done: $('#done').value.trim(), note: $('#note').value.trim()
    };
  }

  function upsert(status='draft'){
    const u=active(); if(!u) return;
    const arr=allCards(); const now=new Date().toISOString(); const fields=gather();
    const i=arr.findIndex(c=>c.id===currentId);
    const payload={ id: currentId||uid(), user: u.username, createdAt: i>=0?arr[i].createdAt: now, updatedAt: now, status, fields };
    if(i>=0) arr[i]=payload; else arr.push(payload);
    setCards(arr);
  }

  function requiredOk(){
    const r=(cfg().requiredFields||[]); const f=gather();
    for(const k of r){ if(!String(f[k]??'').trim()){ alert('Manglende felt: '+k); return false; } }
    return true;
  }

  function buildMail(f){
    const c=cfg(); const to=(c.emails||'pb@bredsgaard.dk').replace(/\s+/g,'');
    const subj=`${c.subjectPrefix||'Arbejdskort'} â€“ ${f.date} â€“ ${f.name} â€“ ${f.customer||''}`;
    const footer=(c.footer||'Ref.: {dato} â€“ {medarbejder}').replace('{dato}',f.date).replace('{medarbejder}',f.name);
    const body=`
Medarbejder: ${f.name}
Dato: ${f.date}

Kunde: ${f.customer}
Lokation: ${f.location}

Maskine/Model: ${f.machine}
Maskin nr: ${f.machineNo}

Arbejdet art:
${f.work}

Fejlbeskrivelse:
${f.fault}

UdfÃ¸rt arbejde:
${f.done}

Forbrug/tider:
- Normal: ${f.hours} t
- Overtimer: ${f.overtime} t
- Maskintimer: ${f.mhours} t
- KÃ¸rte km: ${f.km} km
- Svejsning: ${f.welding} t
- Elektroder: ${f.electrodes} stk
- Diesel: ${f.diesel} L

BemÃ¦rkninger:
${f.note}

${footer}`.trim();
    return `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
  }

  $('#save').onclick = ()=>{ upsert('draft'); alert('Gemte som udkast.'); };
  document.getElementById('form').addEventListener('submit', e=>{
    e.preventDefault();
    if(!requiredOk()) return;
    upsert('sent');
    window.location.href=buildMail(gather());
    setTimeout(()=>{ showDash(); },300);
  });

  // billede preview
  const file = document.getElementById('images');
  if (file) {
    file.addEventListener('change', ()=>{
      const box=document.getElementById('preview'); if (!box) return;
      box.innerHTML=''; [...file.files].slice(0,5).forEach(f=>{ const img=document.createElement('img'); img.src=URL.createObjectURL(f); img.alt=f.name; box.appendChild(img); });
    });
  }

  // init
  resetToLogin();
})();
</script>
</body>
</html>
