<!doctype html><html lang="da"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin – Arbejdskort</title>
<link rel="stylesheet" href="css/style.css">
</head><body>
<div class="topbar"><div class="wrap">
  <div>Admin – Arbejdskort</div>
  <div id="awho"></div>
</div></div>

<div class="wrap">
  <!-- LÅS -->
  <div id="alock" class="card">
    <h1>Admin adgang</h1>
    <div class="row">
      <div><label>Admin-brugernavn</label><input id="au" placeholder="Brugernavn" autocomplete="username"></div>
      <div><label>Admin-kode</label><input id="ap" type="password" placeholder="Kode" autocomplete="current-password"></div>
    </div>
    <div style="margin-top:12px"><button class="btn" id="aopen">Lås op</button></div>
  </div>

  <!-- PANEL -->
  <div id="apanel" style="display:none">
    <div class="card">
      <h1>Indstillinger</h1>
      <div class="row-3">
        <div><label>Admin-brugernavn</label><input id="s_admin_user" placeholder="Brugernavn"></div>
        <div><label>Ny admin-kode (min. 4 cifre)</label><input id="s_admin_pin" placeholder="••••"></div>
        <div><label>Behold kladder (dage)</label><input id="s_keep" inputmode="numeric" value="7"></div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label>Modtager-e-mails (komma)</label>
          <input id="s_emails" placeholder="pb@bredsgaard.dk, ...">
        </div>
        <div>
          <label>Emne-prefix</label>
          <input id="s_subj" placeholder="Arbejdskort">
        </div>
      </div>

      <div style="margin-top:8px"><label>Mail-footer</label><textarea id="s_footer" placeholder="Venlig hilsen&#10;Bredsgaard A/S"></textarea></div>

      <div class="row" style="margin-top:8px">
        <div>
          <label>Arbejdstyper (én pr. linje)</label>
          <textarea id="s_types" placeholder="Service&#10;Olieskift&#10;Kædeskift"></textarea>
        </div>
        <div>
          <label>Påkrævede felter</label>
          <div id="s_req"></div>
          <div class="mut">Disse skal udfyldes før “Send”.</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2>Forbrugsliste</h2>
        <div class="row-3">
          <div><label>Navn</label><input id="c_name" placeholder="Fx Olie"></div>
          <div><label>Enhed</label><input id="c_unit" placeholder="Fx L / stk"></div>
          <div><label>&nbsp;</label><button class="btn" id="c_add">Tilføj</button></div>
        </div>
        <table style="margin-top:8px"><thead><tr><th>Navn</th><th>Enhed</th><th></th></tr></thead><tbody id="c_tbl"></tbody></table>
      </div>

      <div style="margin-top:12px"><button class="btn" id="s_save">Gem indstillinger</button></div>
    </div>

    <div class="card">
      <h1>Brugere</h1>
      <div class="row-3">
        <div><label>Navn</label><input id="u_name" placeholder="Fx Per Bonde"></div>
        <div><label>Brugernavn</label><input id="u_user" placeholder="Fx pbo"></div>
        <div><label>Ny kode (4+ cifre)</label><input id="u_code" placeholder="••••"></div>
      </div>
      <div style="margin-top:8px"><button class="btn" id="u_add">Tilføj / Opdatér</button> <span id="u_msg" class="mut"></span></div>
      <table style="margin-top:8px"><thead><tr><th>Navn</th><th>Brugernavn</th><th>Aktiv</th><th>Handling</th></tr></thead><tbody id="u_tbl"></tbody></table>
    </div>
  </div>
</div>

<script>
const api=(p,opt={})=>fetch(p,opt);
const ah = { get(){ try{return JSON.parse(localStorage.getItem('ak_admin_hdr_v1')||'null')}catch{return null} },
              set(v){ localStorage.setItem('ak_admin_hdr_v1', JSON.stringify(v)); },
              clear(){ localStorage.removeItem('ak_admin_hdr_v1'); } };

const reqFields = [
  {key:'dato',label:'Dags dato'},
  {key:'arbejdet_art',label:'Arbejdet art'},
  {key:'udfoert',label:'Udført arbejde'}
];

async function init(){
  const hdr = ah.get();
  if(hdr){ $('#alock').style.display='none'; $('#apanel').style.display=''; $('#awho').textContent=`Admin: ${hdr['x-admin-user']}`; await loadAll(); }
}
init();

function $(s){ return document.querySelector(s); }

$('#aopen').addEventListener('click', async ()=>{
  const u=$('#au').value.trim(); const p=$('#ap').value.trim();
  const r=await api('/api/login',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({username:u,code:p})});
  const d=await r.json();
  if(d.success && d.role==='admin'){
    ah.set({'x-admin-user':u,'x-admin-pin':p});
    location.reload();
  }else alert('Forkert admin-login');
});

async function loadAll(){
  // indstillinger
  const s = await (await api('/api/settings')).json();
  $('#s_admin_user').value=s.adminUser||'';
  $('#s_keep').value=s.keepDays||7;
  $('#s_emails').value=(s.emailTo||[]).join(', ');
  $('#s_subj').value=s.mailSubjectPrefix||'';
  $('#s_footer').value=s.mailFooter||'';
  $('#s_types').value=(s.workTypes||[]).join('\n');

  // req felter
  const box=$('#s_req'); box.innerHTML='';
  reqFields.forEach(f=>{
    const id='rf_'+f.key; const chk=document.createElement('label'); chk.style.display='block';
    chk.innerHTML=`<input type="checkbox" id="${id}"> ${f.label}`;
    box.append(chk); if((s.requiredFields||[]).includes(f.key)) $('#'+id).checked=true;
  });

  // consumables
  drawCons(s.consumables||[]);

  // brugere
  drawUsers(await (await api('/api/users')).json());
}

function drawCons(list){
  const tb=$('#c_tbl'); tb.innerHTML='';
  list.forEach((c,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.name}</td><td>${c.unit||''}</td><td><span class="link" data-del="${i}">Slet</span></td>`;
    tb.append(tr);
  });
  tb.querySelectorAll('[data-del]').forEach(a=>a.addEventListener('click',()=>{ list.splice(parseInt(a.dataset.del,10),1); drawCons(list); }));
  // gem på window for s_save
  window._cons=list;
}
$('#c_add').addEventListener('click', ()=>{
  const n=$('#c_name').value.trim(), u=$('#c_unit').value.trim();
  if(!n) return; (window._cons=window._cons||[]).push({name:n,unit:u}); $('#c_name').value=''; $('#c_unit').value=''; drawCons(window._cons);
});

$('#s_save').addEventListener('click', async ()=>{
  const hdr=ah.get(); if(!hdr) return;
  const req=reqFields.filter(f=>$('#rf_'+f.key).checked).map(f=>f.key);
  const payload={
    adminUser: $('#s_admin_user').value.trim(),
    newAdminPin: $('#s_admin_pin').value.trim(),
    keepDays: parseInt($('#s_keep').value||'7',10),
    emailTo: $('#s_emails').value.split(',').map(s=>s.trim()).filter(Boolean),
    mailSubjectPrefix: $('#s_subj').value,
    mailFooter: $('#s_footer').value,
    workTypes: $('#s_types').value.split('\n').map(s=>s.trim()).filter(Boolean),
    consumables: window._cons||[],
    requiredFields: req
  };
  const r=await api('/api/settings',{method:'POST',headers:{'content-type':'application/json',...hdr},body:JSON.stringify(payload)});
  if(r.ok){ alert('Indstillinger gemt'); if(payload.newAdminPin) { ah.set({'x-admin-user':payload.adminUser||hdr['x-admin-user'],'x-admin-pin':$('#s_admin_pin').value}); } }
  else alert('Fejl ved gem');
});

function drawUsers(list){
  const tb=$('#u_tbl'); tb.innerHTML='';
  list.forEach(u=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${u.name}</td><td>${u.username}</td><td>${u.active?'Ja':'Nej'}</td>
    <td><span class="link" data-act="edit" data-id="${u.username}">Redigér</span> • <span class="link" data-act="del" data-id="${u.username}">Slet</span></td>`;
    tb.append(tr);
  });
  tb.querySelectorAll('[data-act="edit"]').forEach(a=>a.addEventListener('click',()=>{
    const u=list.find(x=>x.username===a.dataset.id);
    $('#u_name').value=u.name; $('#u_user').value=u.username; $('#u_code').value='';
  }));
  tb.querySelectorAll('[data-act="del"]').forEach(a=>a.addEventListener('click',async ()=>{
    const hdr=ah.get(); await api('/api/users?username='+encodeURIComponent(a.dataset.id),{method:'DELETE',headers:hdr});
    drawUsers(await (await api('/api/users')).json());
  }));
}

$('#u_add').addEventListener('click', async ()=>{
  const hdr=ah.get(); if(!hdr) return;
  const payload={ name: $('#u_name').value.trim(), username: $('#u_user').value.trim(), code: $('#u_code').value.trim() };
  const r=await api('/api/users',{method:'POST',headers:{'content-type':'application/json',...hdr},body:JSON.stringify(payload)});
  const d=await r.json(); $('#u_msg').textContent = d?.error ? ('Fejl: '+d.error) : 'Gemt';
  drawUsers(await (await api('/api/users')).json());
});

// helpers
</script>
</body></html>

