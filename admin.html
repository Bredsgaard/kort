<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin – Arbejdskort</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
<header class="top">
  <div class="brand">
    <img src="img/logo.png" alt="" onerror="this.style.display='none'">
    <h1 id="appTitle">Admin</h1>
  </div>
  <nav><a href="index.html">Arbejdskort</a></nav>
</header>

<main>
  <!-- ADMIN LOCK -->
  <section id="adminLock" class="card" autocomplete="off">
    <h2>Admin adgang</h2>
    <label>Admin-kode</label>
    <input
      type="password"
      id="adminPin"
      inputmode="numeric"
      pattern="[0-9]*"
      placeholder="••••"
      autocomplete="new-password"
      autocapitalize="off"
      autocorrect="off"
      spellcheck="false"
    />
    <div class="actions">
      <button class="primary" id="adminUnlock">Lås op</button>
    </div>
    <p id="adminMsg" class="danger" style="display:none;margin-top:8px"></p>
  </section>

  <!-- INDSTILLINGER -->
  <section id="panel" class="card" style="display:none" autocomplete="off">
    <h2>Indstillinger</h2>

    <label>App-navn (vises i toppen)</label>
    <input id="appName" placeholder="Fx Bredsgaard Arbejdskort" />

    <div class="grid-2">
      <div>
        <label>Standard modtager-e-mails (komma-separeret)</label>
        <input id="emails" placeholder="pb@bredsgaard.dk, vaerksted@..." />
      </div>
      <div>
        <label>Emne-prefix</label>
        <input id="subjectPrefix" placeholder="Arbejdskort" />
      </div>
    </div>

    <label>Mail-footer (brug {dato} og {medarbejder})</label>
    <textarea id="footer" rows="2">Ref.: {dato} – {medarbejder}</textarea>

    <div class="grid-2">
      <div>
        <label>Auto-oprydning (dage for UDKAST)</label>
        <input id="retentionDays" type="number" min="1" value="7" />
      </div>
      <div>
        <label>Påkrævede felter (før afsendelse)</label>
        <div class="card" style="padding:10px">
          <label><input type="checkbox" class="req" value="date"> Dato</label>
          <label><input type="checkbox" class="req" value="name"> Medarbejdernavn</label>
          <label><input type="checkbox" class="req" value="customer"> Kunde</label>
          <label><input type="checkbox" class="req" value="location"> Lokation</label>
          <label><input type="checkbox" class="req" value="machineNo"> Maskin nr</label>
          <label><input type="checkbox" class="req" value="machine"> Maskine/Model</label>
          <label><input type="checkbox" class="req" value="work"> Arbejdets art</label>
          <label><input type="checkbox" class="req" value="fault"> Fejlbeskrivelse</label>
          <label><input type="checkbox" class="req" value="done"> Udført arbejde</label>
          <label><input type="checkbox" class="req" value="hours"> Normal timer</label>
          <label><input type="checkbox" class="req" value="overtime"> Overtimer</label>
          <label><input type="checkbox" class="req" value="mhours"> Maskintimer</label>
          <label><input type="checkbox" class="req" value="km"> Kørte km</label>
          <label><input type="checkbox" class="req" value="welding"> Svejsning (timer)</label>
          <label><input type="checkbox" class="req" value="electrodes"> Elektroder (stk)</label>
          <label><input type="checkbox" class="req" value="diesel"> Diesel (liter)</label>
          <label><input type="checkbox" class="req" value="note"> Bemærkninger</label>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="primary" id="saveCfg">Gem indstillinger</button>
      <button id="resetCfg">Nulstil</button>
    </div>
  </section>

  <!-- BRUGERE (koder vises aldrig) -->
  <section id="usersCard" class="card" style="display:none" autocomplete="off">
    <h2>Brugere</h2>
    <div class="grid-3">
      <div><label>Navn</label><input id="uName" placeholder="Fx Per Bonde" /></div>
      <div><label>Brugernavn</label><input id="uUsername" placeholder="fx pbo" autocapitalize="off" /></div>
      <div>
        <label>Ny kode (valgfri ved redigering)</label>
        <input
          type="password"
          id="uCode"
          placeholder="••••"
          inputmode="numeric"
          pattern="[0-9]*"
          autocomplete="new-password"
          autocapitalize="off"
          autocorrect="off"
          spellcheck="false"
        />
      </div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button class="primary" id="addUser">Tilføj / Opdatér</button>
      <button id="clearInputs">Ryd</button>
    </div>

    <div class="tableWrap">
      <table class="table">
        <thead><tr><th>Navn</th><th>Brugernavn</th><th>Aktiv</th><th>Handling</th></tr></thead>
        <tbody id="usersTable"></tbody>
      </table>
    </div>
  </section>
</main>

<footer>© Bredsgaard A/S</footer>

<script>
(() => {
  // fast admin
  const ADMIN_CODE = '0705';
  const ADMIN_USERNAME = 'Bonde';

  // storage keys
  const LS_ADMIN = 'ak_admin_v3';
  const LS_USERS = 'ak_users_v2';

  const $ = s => document.querySelector(s);
  const getCfg = () => JSON.parse(localStorage.getItem(LS_ADMIN) || '{}');
  const setCfg = v => localStorage.setItem(LS_ADMIN, JSON.stringify(v));
  const getUsers = () => JSON.parse(localStorage.getItem(LS_USERS) || '[]');
  const setUsers = v => localStorage.setItem(LS_USERS, JSON.stringify(v));

  // Ryd evt. autofyld ved load
  document.addEventListener('DOMContentLoaded', () => {
    const pin = document.getElementById('adminPin');
    if (pin) { pin.value = ''; pin.form && (pin.form.autocomplete = 'off'); }
  });

  // Sørg for, at admin-bruger findes (kan ikke slettes)
  function ensureAdminUser(){
    const arr = getUsers();
    const i = arr.findIndex(u => (u.username||'').toLowerCase() === ADMIN_USERNAME.toLowerCase());
    if (i < 0) {
      arr.push({ name: 'Admin', username: ADMIN_USERNAME, code: ADMIN_CODE, active: true, system: true });
      setUsers(arr);
    } else {
      // hold altid aktiv/system-flag
      arr[i].active = true; arr[i].system = true;
      setUsers(arr);
    }
  }
  ensureAdminUser();

  // Admin unlock
  $('#adminUnlock').onclick = () => {
    const val = ($('#adminPin').value || '').trim();
    if (val === ADMIN_CODE) {
      $('#adminLock').style.display='none';
      $('#panel').style.display='';
      $('#usersCard').style.display='';
      load();
    } else {
      $('#adminMsg').textContent='Forkert kode.'; $('#adminMsg').style.display='block';
    }
  };

  // Load/save cfg
  function load(){
    const c=getCfg();
    $('#appTitle').textContent = c.appName || 'Admin';
    $('#appName').value = c.appName || 'Bredsgaard Arbejdskort';
    $('#emails').value = c.emails || 'pb@bredsgaard.dk';
    $('#subjectPrefix').value = c.subjectPrefix || 'Arbejdskort';
    $('#footer').value = c.footer || 'Ref.: {dato} – {medarbejder}';
    $('#retentionDays').value = c.retentionDays || 7;
    document.querySelectorAll('.req').forEach(cb => cb.checked = (c.requiredFields||[]).includes(cb.value));
    renderUsers();
  }

  $('#saveCfg').onclick = () => {
    const required = [...document.querySelectorAll('.req')].filter(cb=>cb.checked).map(cb=>cb.value);
    setCfg({
      appName: $('#appName').value.trim(),
      emails: $('#emails').value.trim(),
      subjectPrefix: ($('#subjectPrefix').value.trim() || 'Arbejdskort'),
      footer: $('#footer').value,
      retentionDays: Math.max(1, parseInt($('#retentionDays').value||'7',10)),
      requiredFields: required
    });
    alert('Indstillinger gemt.');
  };

  $('#resetCfg').onclick = () => { localStorage.removeItem(LS_ADMIN); load(); };

  // Users (koder vises aldrig)
  function renderUsers(){
    const tbody = $('#usersTable'); tbody.innerHTML='';
    getUsers().forEach((u,i)=>{
      const isAdmin = (u.username||'').toLowerCase() === ADMIN_USERNAME.toLowerCase();
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${u.name}${isAdmin?' (admin)':''}</td>
        <td>${u.username}</td>
        <td>${u.active!==false?'Ja':'Nej'}</td>
        <td class="actions-inline">
          <button data-i="${i}" class="edit">Redigér</button>
          ${isAdmin ? '' : `<button data-i="${i}" class="toggle">${u.active!==false?'Deaktivér':'Aktivér'}</button>
          <button data-i="${i}" class="del danger">Slet</button>`}
        </td>`;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('.edit').forEach(b=>b.onclick=e=>{
      const u=getUsers()[+e.target.dataset.i];
      $('#uName').value=u.name; $('#uUsername').value=u.username; $('#uCode').value='';
    });

    tbody.querySelectorAll('.toggle').forEach(b=>b.onclick=e=>{
      const i=+e.target.dataset.i; const arr=getUsers();
      if ((arr[i].username||'').toLowerCase() === ADMIN_USERNAME.toLowerCase()) return;
      arr[i].active=!(arr[i].active!==false); setUsers(arr); renderUsers();
    });

    tbody.querySelectorAll('.del').forEach(b=>b.onclick=e=>{
      const i=+e.target.dataset.i; const arr=getUsers();
      if ((arr[i].username||'').toLowerCase() === ADMIN_USERNAME.toLowerCase()) return;
      if (confirm('Slet bruger?')){ arr.splice(i,1); setUsers(arr); renderUsers(); }
    });
  }

  $('#addUser').onclick = () => {
    const name=$('#uName').value.trim(),
          username=$('#uUsername').value.trim(),
          newCode=$('#uCode').value.trim(); // tom = behold gammel

    if(!name||!username) return alert('Udfyld navn og brugernavn');

    const arr=getUsers();
    const i=arr.findIndex(u=> (u.username||'').toLowerCase()===username.toLowerCase());

    if(i>=0){
      // opdater eksisterende – kun skift kode hvis udfyldt
      arr[i].name = name;
      arr[i].username = username;
      if (newCode) arr[i].code = newCode;
      arr[i].active = true;
    } else {
      if(!newCode) return alert('Angiv en kode for nye brugere');
      arr.push({name, username, code:newCode, active:true});
    }
    setUsers(arr); renderUsers();
    $('#uCode').value=''; // vis aldrig kode efter gem
    alert('Bruger gemt.');
  };

  $('#clearInputs').onclick = ()=>{ $('#uName').value=''; $('#uUsername').value=''; $('#uCode').value=''; };
})();
</script>
</body>
</html>
