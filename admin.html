<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin – Arbejdskort</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
<header class="top">
  <div class="brand">
    <img src="img/logo.png" alt="" onerror="this.style.display='none'">
    <h1 id="appTitle">Admin</h1>
  </div>
  <nav class="actions-inline">
    <a class="link" href="index.html">Nyt arbejdskort</a>
    <a class="link" href="history.html">Tidligere</a>
  </nav>
</header>

<main>
  <section id="adminLock" class="card">
    <h2>Admin adgang</h2>
    <form id="adminForm" autocomplete="off">
      <div class="grid-2">
        <div><label>Admin-brugernavn</label><input id="adminUser" placeholder="Bonde" /></div>
        <div><label>Admin-kode</label><input type="password" id="adminPin" inputmode="numeric" pattern="[0-9]*" placeholder="••••" /></div>
      </div>
      <div class="actions"><button class="primary" id="adminUnlock" type="submit">Lås op</button></div>
      <p id="adminMsg" class="danger" style="display:none;margin-top:8px"></p>
    </form>
  </section>

  <section id="panel" class="card" style="display:none">
    <h2>Indstillinger</h2>
    <label>App-navn</label><input id="appName" placeholder="Fx Bredsgaard Arbejdskort" />
    <div class="grid-2">
      <div><label>Modtager-e-mails (komma)</label><input id="emails" placeholder="pb@bredsgaard.dk" /></div>
      <div><label>Emne-prefix</label><input id="subjectPrefix" placeholder="Arbejdskort" /></div>
    </div>
    <label>Mail-footer (brug {dato} og {medarbejder})</label><textarea id="footer" rows="2">Ref.: {dato} – {medarbejder}</textarea>

    <div class="grid-2">
      <div><label>Auto-oprydning (udkast, dage)</label><input id="retentionDays" type="number" min="1" value="7" /></div>
      <div>
        <label>Påkrævede felter</label>
        <div class="card" style="padding:10px">
          <label><input type="checkbox" class="req" value="date"> Dato</label>
          <label><input type="checkbox" class="req" value="name"> Medarbejdernavn</label>
          <label><input type="checkbox" class="req" value="customer"> Kunde</label>
          <label><input type="checkbox" class="req" value="location"> Lokation</label>
          <label><input type="checkbox" class="req" value="machineNo"> Maskin nr</label>
          <label><input type="checkbox" class="req" value="machine"> Maskine/Model</label>
          <label><input type="checkbox" class="req" value="work"> Arbejdet art</label>
          <label><input type="checkbox" class="req" value="fault"> Fejlbeskrivelse</label>
          <label><input type="checkbox" class="req" value="done"> Udført arbejde</label>
          <label><input type="checkbox" class="req" value="hours"> Normal timer</label>
          <label><input type="checkbox" class="req" value="overtime"> Overtimer</label>
          <label><input type="checkbox" class="req" value="mhours"> Maskintimer</label>
          <label><input type="checkbox" class="req" value="km"> Kørte km</label>
          <label><input type="checkbox" class="req" value="welding"> Svejsning</label>
          <label><input type="checkbox" class="req" value="electrodes"> Elektroder</label>
          <label><input type="checkbox" class="req" value="diesel"> Diesel</label>
          <label><input type="checkbox" class="req" value="note"> Bemærkninger</label>
        </div>
      </div>
    </div>

    <label>Arbejdstyper (én pr. linje)</label>
    <textarea id="workPresets" rows="3" placeholder="Service&#10;Olieskift&#10;Kædeskift"></textarea>

    <h3 style="margin-top:16px">Forbrugsliste</h3>
    <div class="grid-3">
      <input id="consName" placeholder="Navn (fx Olie)" />
      <input id="consUnit" placeholder="Enhed (fx L / stk)" />
      <button id="consAdd" type="button">Tilføj</button>
    </div>
    <div class="tableWrap" style="margin-top:8px">
      <table class="table"><thead><tr><th>Navn</th><th>Enhed</th><th>Handling</th></tr></thead>
      <tbody id="consTable"></tbody></table>
    </div>

    <div class="actions">
      <button class="primary" id="saveCfg" type="button">Gem indstillinger</button>
      <button id="resetCfg" type="button">Nulstil</button>
    </div>
  </section>

  <section id="usersCard" class="card" style="display:none">
    <h2>Brugere</h2>
    <form id="userForm" autocomplete="off">
      <div class="grid-3">
        <div><label>Navn</label><input id="uName" placeholder="Fx Per Bonde" /></div>
        <div><label>Brugernavn</label><input id="uUsername" placeholder="fx pbo" autocapitalize="off" /></div>
        <div><label>Ny kode (4+ cifre)</label><input type="password" id="uCode" placeholder="••••" inputmode="numeric" pattern="[0-9]*" /></div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button class="primary" id="addUser" type="submit">Tilføj / Opdatér</button>
        <button id="clearInputs" type="button">Ryd</button>
      </div>
      <p id="userMsg" style="display:none"></p>
    </form>

    <div class="tableWrap">
      <table class="table">
        <thead><tr><th>Navn</th><th>Brugernavn</th><th>Aktiv</th><th>Handling</th></tr></thead>
        <tbody id="usersTable"></tbody>
      </table>
    </div>
  </section>
</main>

<footer>© Bredsgaard A/S</footer>

<script>
(() => {
  const ADMIN_HEADERS = { 'x-admin-user':'Bonde', 'x-admin-pin':'0705', 'Content-Type':'application/json' };
  const $ = s => document.querySelector(s);

  // ---- API helpers ----
  const loadSettings = async () => (await (await fetch('/api/settings')).json());
  const saveSettings = async (cfg) => (await (await fetch('/api/settings', {method:'POST', headers: ADMIN_HEADERS, body: JSON.stringify(cfg)})).json());
  const listUsers  = async () => (await (await fetch('/api/users')).json());
  const upsertUser = async (u)  => (await (await fetch('/api/users',{method:'POST', headers: ADMIN_HEADERS, body: JSON.stringify(u)})).json());
  const delUser    = async (username)=> (await (await fetch('/api/users?username='+encodeURIComponent(username),{method:'DELETE', headers: ADMIN_HEADERS})).json());
  const toggleUser = async (username,active)=> (await (await fetch('/api/users',{method:'PATCH', headers: ADMIN_HEADERS, body: JSON.stringify({username,active})})).json());

  // ---- Admin login (klient-side gate) ----
  document.getElementById('adminForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const un = (document.getElementById('adminUser').value||'').trim();
    const pin= (document.getElementById('adminPin').value||'').trim();
    if (un==='Bonde' && pin==='0705'){
      document.getElementById('adminLock').style.display='none';
      document.getElementById('panel').style.display='';
      document.getElementById('usersCard').style.display='';
      await initSettings();
      await renderUsers();
    } else {
      document.getElementById('adminMsg').textContent='Forkert admin-brugernavn eller kode.';
      document.getElementById('adminMsg').style.display='block';
    }
  });

  // ---- Indstillinger ----
  let SETTINGS = {};
  async function initSettings(){
    SETTINGS = await loadSettings();
    document.getElementById('appTitle').textContent = SETTINGS.appName || 'Admin';
    document.getElementById('appName').value = SETTINGS.appName || 'Bredsgaard Arbejdskort';
    document.getElementById('emails').value = SETTINGS.emails || 'pb@bredsgaard.dk';
    document.getElementById('subjectPrefix').value = SETTINGS.subjectPrefix || 'Arbejdskort';
    document.getElementById('footer').value = SETTINGS.footer || 'Ref.: {dato} – {medarbejder}';
    document.getElementById('retentionDays').value = SETTINGS.retentionDays || 7;
    document.getElementById('workPresets').value = (SETTINGS.workPresets||[]).join('\n');
    document.querySelectorAll('.req').forEach(cb => cb.checked = (SETTINGS.requiredFields||[]).includes(cb.value));
    renderCons(SETTINGS.consumables||[]);
  }

  function renderCons(arr){
    const tb=document.getElementById('consTable'); tb.innerHTML='';
    arr.forEach((x,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${x.name}</td><td>${x.unit||''}</td><td><button data-i="${i}" class="del danger">Slet</button></td>`;
      tb.appendChild(tr);
    });
    tb.querySelectorAll('.del').forEach(b=>b.onclick=async e=>{
      const i=+e.target.dataset.i; SETTINGS.consumables.splice(i,1); await saveSettings(SETTINGS); renderCons(SETTINGS.consumables);
    });
  }

  document.getElementById('consAdd').onclick = async ()=>{
    const name=(document.getElementById('consName').value||'').trim();
    const unit=(document.getElementById('consUnit').value||'').trim();
    if(!name) return;
    SETTINGS.consumables = SETTINGS.consumables||[];
    SETTINGS.consumables.push({ id: (crypto.randomUUID?crypto.randomUUID():Date.now().toString(36)), name, unit });
    await saveSettings(SETTINGS);
    document.getElementById('consName').value=''; document.getElementById('consUnit').value='';
    renderCons(SETTINGS.consumables);
  };

  document.getElementById('saveCfg').onclick = async ()=>{
    const required = [...document.querySelectorAll('.req')].filter(cb=>cb.checked).map(cb=>cb.value);
    SETTINGS = {
      ...SETTINGS,
      appName: document.getElementById('appName').value.trim(),
      emails: document.getElementById('emails').value.trim(),
      subjectPrefix: (document.getElementById('subjectPrefix').value.trim() || 'Arbejdskort'),
      footer: document.getElementById('footer').value,
      retentionDays: Math.max(1, parseInt(document.getElementById('retentionDays').value||'7',10)),
      requiredFields: required,
      workPresets: (document.getElementById('workPresets').value||'').split('\n').map(s=>s.trim()).filter(Boolean),
      consumables: SETTINGS.consumables||[]
    };
    await saveSettings(SETTINGS);
    alert('Indstillinger gemt på serveren.');
  };

  document.getElementById('resetCfg').onclick = async ()=>{
    SETTINGS = {}; await saveSettings(SETTINGS); await initSettings();
  };

  // ---- Brugere ----
  async function renderUsers(){
    const users = await listUsers();
    const tbody = document.getElementById('usersTable'); tbody.innerHTML='';
    users.forEach(u=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${u.name}</td><td>${u.username}</td><td>${u.active!==false?'Ja':'Nej'}</td>
        <td class="actions-inline">
          <button class="edit" data-u="${u.username}">Redigér</button>
          ${u.username.toLowerCase()==='bonde' ? '' : `
          <button class="toggle" data-u="${u.username}" data-a="${u.active!==false?'0':'1'}">${u.active!==false?'Deaktivér':'Aktivér'}</button>
          <button class="del danger" data-u="${u.username}">Slet</button>`}
        </td>`;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('.edit').forEach(b=>b.onclick=e=>{
      const u = users.find(x=>x.username===e.target.dataset.u);
      document.getElementById('uName').value=u.name; document.getElementById('uUsername').value=u.username; document.getElementById('uCode').value='';
    });
    tbody.querySelectorAll('.toggle').forEach(b=>b.onclick=async e=>{
      const un=e.target.dataset.u, a=e.target.dataset.a==='1'; await toggleUser(un,a); await renderUsers();
    });
    tbody.querySelectorAll('.del').forEach(b=>b.onclick=async e=>{
      if (!confirm('Slet bruger?')) return; await delUser(e.target.dataset.u); await renderUsers();
    });
  }

  document.getElementById('userForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const name=(document.getElementById('uName').value||'').trim();
    const username=(document.getElementById('uUsername').value||'').trim();
    const code=(document.getElementById('uCode').value||'').trim();
    function msg(t){ const p=document.getElementById('userMsg'); p.textContent=t; p.style.display='block'; setTimeout(()=>p.style.display='none',2200); }
    if(!name || !username) return msg('Udfyld både Navn og Brugernavn.');
    const res = await upsertUser({ name, username, code });
    if (!res.ok) return msg(res.error==='need_code' ? 'Angiv en kode for ny bruger.' : 'Fejl ved gem.');
    document.getElementById('uName').value=''; document.getElementById('uUsername').value=''; document.getElementById('uCode').value='';
    await renderUsers(); msg('Bruger gemt.');
  });

  document.getElementById('clearInputs').onclick = ()=>{
    document.getElementById('uName').value=''; document.getElementById('uUsername').value=''; document.getElementById('uCode').value='';
  };
})();
</script>
</body>
</html>
